{% extends base_template %}
{% load static %}
{% load widgets %}
{% load krono_urls %}
{% load searchform %}
{% load header %}

{% block header %}
{% fotosphere_header %}
{% endblock header %}

{% block content %}
<style>
    svg.leaflet-tile {
        overflow: visible
    }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<div class="photosphere" x-data="{ open: false }" @kronofoto-select-photosphere-marker="open = true" @node-changed="open = false">

    <div id="fi-photosphere-metadata" class="photosphere__metadata hide">
        {% block photosphere_metadata %}
        <h2>{{ object.title }}</h2>
        <div>{{ object.description | markdown }}</div>
        {% if object.mainstreetset.description %}<div>{{ object.mainstreetset.description }}</div>{% endif %}
        {% endblock photosphere_metadata %}
    </div>
    <form class="photosphere__wrapper" hx-get="{% krono_url "kronofoto:mainstreetview" %}" hx-trigger="node-changed" hx-target="#fi-photosphere-metadata">
        <div id="fi-photosphere" class="photosphere__view" data-photosphere-data="#photosphere-data" data-node-href="{% krono_url "kronofoto:mainstreetview.json" %}" data-node-start="{{ object.id }}" data-node-param="id" style="width: 100vw;" data-mainstreet-tiles="{{ mainstreet_tiles }}">
            <input name="id" type="hidden">
        </div>
    </form>
    <div class="photosphere__set_description" x-data="{ open: false }" x-bind:class="{ 'expanded': open }">
        <button class="photosphere__set_description_button" x-on:click="open = !open"></button>
        <div class="photosphere__set_description_text" x-show="open">
            {% if object.mainstreetset.name %}<h3>{{ object.mainstreetset.name }}</h3>{% endif %}
            {% if mainstreet_description %}<div>{{ mainstreet_description }}</div>{% endif %}
        </div>

    </div>
    <div class="photosphere__info-box hide" x-show="open">
        <button @click="open = false" class="close-btn">Close</button>
        <div
            id="photosphere-info-box"
            hx-trigger="kronofoto-select-photosphere-marker from:previous form"
            hx-vals="js:{id: event.detail.id}"
            hx-get="{% krono_url "kronofoto:mainstreet-info" %}"
            hx-target="this"
            hx-swap="innerHTML"
            hx-push-url="false">
        </div>
    </div>
    <nav id="fi-timeline" class="photosphere__timeline fi-timeline">
        <form
            hx-trigger="kronofoto:loadThumbnails"
            hx-target="#fi-thumbnail-carousel-images"
            hx-get="{% krono_url "kronofoto:mainstreetview-carousel" %}"
            hx-push-url="false"
            hx-swap="beforeend"
            hx-sync="this:drop"
        >
        {{ thumbnails_form }}
        <ul id="fi-preload-zone"></ul>
        <div data-fi-load-thumbnails class="hide"></div>
        <div class="fi-thumbnail-carousel" hx-target="#fi-photosphere-metadata" hx-swap="innerHTML">
            {% include "kronofoto/components/thumbnail-carousel.html" with object_list=photos width_element="#fi-photosphere" is_mainstreet=True %}
        </div>
        </form>
    </nav>
    <ul class="button-list button-list--horizontal" id="related-mainstreets">
        {% for mainstreet in mainstreet_links %}
        <li><a class="year-button active" href="{{ mainstreet.photosphere_href }}">{{ mainstreet.set.name }}</a></li>
        {% endfor %}
    </ul>
</div>
{% endblock %}

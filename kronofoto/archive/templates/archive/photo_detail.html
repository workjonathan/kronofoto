{% extends base_template %}
{% load static %}
{% load cache %}
{% load widgets %}
{% load krono_urls %}
{% load searchform %}

{% block opengraph %}
    <meta property="og:title" content="{{ request.site.name }}: {{ photo.accession_number }}" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="{{ photo.h700.url }}" />
    <meta property="og:url" content="{% object_url photo %}" />
{% endblock %}

{% block viewbuttons %}
{% include "archive/view-buttons.html" with timelineclass="current-view" %}
{% endblock %}
{% block content %}

<main hx-target="#fi-image-tag" hx-swap="outerHTML">


    <div class="gallery" id="gallery" data-toggler=".zoom-opened">
        <div class="gallery__left-space">
            {% block left_arrow %}
            <a id="fi-arrow-left" class="control previous"
               {% if prev_photo %}
               href="{% object_url prev_photo url_kwargs get_params %}"
               hx-get="{% object_url prev_photo url_kwargs get_params %}"
               {% endif %}>
            </a>
            {% endblock %}
        </div>
        <article class="gallery__image fi-image" id="fi-image">
            {% block image %}
            <figure>
                <img id="fi-image-tag" src="{{ photo.h700.url }}" alt="{{ photo|describe:request.user|join:", " }}" />
            </figure>
            {% endblock image %}
        </article>
        <div class="gallery__right-space">
            {% block right_arrow %}
            <a id="fi-arrow-right" class="control forward"
               {% if next_photo %}
               href="{% object_url next_photo url_kwargs get_params %}"
               hx-get="{% object_url next_photo url_kwargs get_params %}"
               {% endif %}>
            </a>
            {% endblock right_arrow %}
        </div>

        <div id="zoom-popup" class="follow-zoom-popup">
            {% block zoom_popup %}
            <div style='background-image: url("{{ object.original.url }}");' id="follow-zoom-timeline-version" class="follow-zoom-timeline-popup-img"></div>

            <!-- script for follow zoom -->
            <script type="text/javascript">
              var addZoom = (target) => {
                let container = document.getElementById(target),
                    imgsrc = container.currentStyle || window.getComputedStyle(container, false);
                imgsrc = imgsrc.backgroundImage.slice(4, -1).replace(/"/g, "");

                let img = new Image();
                let zoomOpened = false
                let zoomed = false
                let galleryElem = document.getElementsByClassName('gallery')[0]
                img.src = imgsrc;
                img.onload = () => {


                  let ratio = img.naturalWidth / img.naturalHeight;

                  Object.assign(container.style, {
                    height: "calc(100vh)",
                    width: "calc(100vw)",
                    backgroundPosition: "top",
                    backgroundSize: "contain",
                    backgroundRepeat: "no-repeat"
                  });

                  let removeZoom = () => {
                    Object.assign(container.style, {
                      backgroundPosition: "top",
                      backgroundSize: "contain"
                    });
                  }

                  container.addEventListener('click', (e) => {
                    zoomed = !zoomed;

                    if(zoomed) {
                      galleryElem.classList.add('zoomed')
                    }
                    else {
                      galleryElem.classList.remove('zoomed')
                      removeZoom()
                    }
                  })

                  container.onmousemove = (e) => {
                    if(zoomed) {
                      let rect = e.target.getBoundingClientRect(),
                          xPos = e.clientX - rect.left,
                          yPos = e.clientY - rect.top,
                          xPercent = ((xPos / container.clientWidth) * 100) + "%",
                          yPercent = ((yPos / container.clientHeight) * 100) + "%";

                      Object.assign(container.style, {
                        backgroundPosition: xPercent + " " + yPercent,
                        backgroundSize: ($(window).width() * 1.5) + "px"
                      });
                    }
                  };

                  // container.onmouseleave = removeZoom

                }
              }

              addZoom("follow-zoom-timeline-version");

            </script>

            {% endblock zoom_popup %}
        </div>

        <div class="gallery__controls">
            {% block image_control_buttons %}

            <div class="gallery__controls-top">
                <!--Zoom Button-->
                <button id="zoom-image-control-button" class="image-control-button" data-toggle="gallery">
                    <img class="meta-info-icon" src="{% static "assets/images/skyblue/zoom.svg" %}">
                </button>
                <!--Auto Play Button-->
                <button id="auto-play-image-control-button" class="image-control-button">
                    <img id="autoplay--play" src="{% static "assets/images/skyblue/auto-play.svg" %}">
                    <img id="autoplay--pause" class="hide" src="{% static "assets/images/skyblue/pause.svg" %}">
                </button>
            </div>
            <div class="gallery__controls-bottom">
                <!--Add to List Button-->
                <button class="image-control-button" data-toggle="add-to-list-popup">
                    <img class="add-to-list-icon" src="{% static "assets/images/skyblue/add-to-list.svg" %}">
                </button>
                <!--Share Button-->
                <button class="image-control-button" data-toggle="share-popup">
                    <img class="meta-info-icon" src="{% static "assets/images/skyblue/share.svg" %}">
                </button>
                <!--Download Button-->
                <button class="image-control-button" data-toggle="download-popup">
                    <img class="meta-dl-icon" src="{% static "assets/images/skyblue/download.svg" %}">
                </button>
                <!--Info Button-->
                <button class="image-control-button" data-toggle="metadata-popup">
                    <img class="meta-info-icon" src="{% static "assets/images/skyblue/info.svg" %}">
                </button>

            </div>
            {% endblock image_control_buttons %}
        </div>

        <div class="gallery__popups">

            <div id="metadata-popup" class="gallery__popup" data-toggler=".expanded">
                <a href="#" class="photo-menu-popup__edit-btn hide"></a>
                <a href="#" class="photo-menu-popup__close-btn" data-toggle="metadata-popup" data-toggler=".expanded"></a>
                <div class="photo-menu-popup__wrapper">
                    {% block metadata %}
                    {% include "archive/photometadata.html" %}
                    {% endblock %}
                </div>
            </div>
            <div id="add-to-list-popup" class="gallery__popup" data-toggler=".expanded" hx-target="find .photo-menu-popup__wrapper"  hx-swap="innerHTML" hx-push-url="false" hx-get="{% krono_url "kronofoto:popup-add-to-list" photo=photo.id %}" hx-trigger="intersect">
                <a href="#" class="photo-menu-popup__close-btn" data-toggle="add-to-list-popup" data-toggler=".expanded"></a><div class="photo-menu-popup__wrapper no-scroll"></div>
            </div>
            <div id="share-popup" class="gallery__popup" data-toggler=".expanded" hx-target="find .photo-menu-popup__wrapper" hx-swap="innerHTML" hx-push-url="false" hx-get="{% krono_url "kronofoto:popup-web-component" url_kwargs photo=photo.id %}?{{ request.GET.urlencode }}" hx-trigger="intersect">
                <a href="#" class="photo-menu-popup__close-btn" data-toggle="share-popup" data-toggler=".expanded"></a><div class="photo-menu-popup__wrapper"></div>
            </div>
    {% block gallery %}
            <div id="download-popup" class="gallery__popup" data-toggler=".expanded" hx-target="find .photo-menu-popup__wrapper" hx-swap="innerHTML" hx-push-url="false" hx-get="{% krono_url "kronofoto:popup-download" photo=photo.id %}" hx-trigger="intersect">
                <a href="#" class="photo-menu-popup__close-btn" data-toggle="download-popup" data-toggler=".expanded"></a><div class="photo-menu-popup__wrapper"></div>
            </div>

        </div>
    {% endblock gallery %}
    </div>

    <div class="car-left-space"></div>


    <nav class="fi-timeline" id="fi-timeline">
    {% block thumbnails %}

        <div class="fi-thumbnail-carousel">

            <div class="back-arrows">
                <a id="backward"></a>
            </div>

            <div class="slide-container">
                <ul id="fi-preload-zone"></ul>
                <ul id="fi-thumbnail-carousel-images">
                    {% include "archive/thumbnails.html" %}
                </ul>
            </div>

            <div class="forward-arrows">
                <a id="forward">
                    <span data-tooltip class="top" data-click-open="false" title="Click to zip,&#xA; hold to crawl"></span>
                </a>
            </div>

        </div>

    {% endblock thumbnails %}
    </nav>



    <form hx-trigger="timeline:yearSelected" hx-get="{% krono_url "kronofoto:year-redirect" url_kwargs %}">
        {% timeline %}
    </form>





    <div class="car-right-space"></div>

</main>
{% endblock %}
